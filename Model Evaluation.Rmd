---
title: "Model Evaluation"
author: "Nick Lagoni"
date: "`r Sys.Date()`"
output: html_document
---
# Setup
```{r}
Sys.setenv(lang='en')
set.seed(42)
library(readr)
library(tidyverse)
library(dplyr)
library(purrr)
library(ggplot2)
library(GGally)
library(corrplot)
library(reshape2)
library(patchwork)
library(e1071)
library(gt)
library(magick)
library(vegan)
library(rsample)
library(randomForest)
library(janitor)
library(caret)
library(Metrics)
library(xgboost)
```

# Data Import and Cleaning
```{r}
transects<-read.csv("transects.csv")
motileInvert_counts<-read.csv("motileInvert_counts.csv")
motileInvert_measurements<-read.csv("motileInvert_measurements.csv")
photoquadrats<-read.csv("photoquadrats.csv")

#Photoplots Pivot
photoquadrats_pivot<-photoquadrats%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Perc_Cover)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Perc_Cover,
    values_fn = mean
  )
#Motile Invert Counts Pivot
motileInvert_counts$Count<-motileInvert_counts$Damage+motileInvert_counts$No.Damage
motileInvert_counts_pivot<-motileInvert_counts%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Count)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Count,
    values_fill = 0
  )
motileInvert_counts_pivot<-motileInvert_counts_pivot%>%
  mutate(across(where(is.numeric), ~ ifelse(. < 0, 0, .)))

#Motile Invert Measurements Pivot

motileInvert_measurements_pivot<-motileInvert_measurements%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Measurement)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Measurement,
    values_fn = mean,
    values_fill = 0
  )
names(motileInvert_measurements_pivot)[(ncol(motileInvert_measurements_pivot)-5):ncol(motileInvert_measurements_pivot)] <- paste0(names(motileInvert_measurements_pivot)[(ncol(motileInvert_measurements_pivot)-5):ncol(motileInvert_measurements_pivot)], " Mean Measure")
```

# Joining the data
```{r}
join_cols<-c("Site_Name","Loc_Name","Target_Species","Plot_Name","Start_Date")
joined_data<-photoquadrats_pivot%>%
  left_join(motileInvert_counts_pivot,by=join_cols)%>%
  left_join(motileInvert_measurements_pivot,by=join_cols)%>%
  mutate(across(everything(), ~replace_na(., 0)))
joined_data<-joined_data%>%
  filter(Site_Name=="Acadia NP")%>%
  select(-Target_Species,-Site_Name)
joined_data <- joined_data %>%
  mutate(Plot_ID = paste(Loc_Name, Plot_Name, sep = " "))%>%
  select(Plot_ID, everything(), -Loc_Name, -Plot_Name)
joined_data$Start_Date<-year(mdy(joined_data$Start_Date))
```

# Training testing split
```{r}
#Using sqrt(p):1 ratio as described in Joseph, 2022. Code adapted from Katherine Geist's Data Science for Biological Sciences course
calcSplitRatio <- function(p = NA, df) {
  if(is.na(p)) {
    p <- ncol(df) -1 
  }
  test_N <- (1/sqrt(p))*nrow(df)
  test_prop <- round((1/sqrt(p))*nrow(df)/nrow(df), 2)
  train_prop <- 1-test_prop
  print(paste0("The ideal split ratio is ", train_prop, ":", test_prop, " training:testing"))
  return(train_prop)
}

train_prop<-calcSplitRatio(df = joined_data)
indices<-initial_split(joined_data,prop=train_prop)
train_data<-training(indices)
test_data<-testing(indices)
```

# Out-of-Bag Random Forest
```{r}
clean_data<-joined_data%>%
  clean_names()
#clean_data<-clean_data[,-c(1:5)]
zero_data<-clean_data%>%
  select(where(is.numeric))%>%
  select(where(~sum(.)==0))
zero_list<-colnames(zero_data)
clean_data<-clean_data%>%
  select(-all_of(zero_list))

percent_cover_cols<-colnames(clean_data[,c(3:26)])
clean_data_lag <- clean_data %>%
  arrange(plot_id, start_date) %>%
  group_by(plot_id) %>%
  mutate(across(all_of(percent_cover_cols), 
                ~ dplyr::lag(., n = 1), 
                .names = "lag1_{col}")) %>%
  ungroup()

# Keep only rows where lag exists; drop first year per site
clean_data_lag <- clean_data_lag %>%
  filter(!is.na(lag1_rockweed_fucus_spp))

# Ascophyllum lagged predictors
asco_predictors <- grep("^lag1_", names(clean_data_lag), value = TRUE)
formula_asco <- as.formula(
  paste("knotted_wrack_a_nodosum ~", paste(asco_predictors, collapse = " + "))
)
# Fucus lagged predictors
fuc_predictors <- grep("^lag1_", names(clean_data_lag), value = TRUE)
formula_fuc <- as.formula(
  paste("rockweed_fucus_spp ~", paste(fuc_predictors, collapse = " + "))
)

oob_asco <- randomForest(formula_asco, data = clean_data_lag, ntree = 500, importance = TRUE)
oob_fuc  <- randomForest(formula_fuc,  data = clean_data_lag, ntree = 500, importance = TRUE)

print(oob_asco)
print(oob_fuc)

# Example OOB plot
plot(oob_asco$predicted, clean_data_lag$knotted_wrack_a_nodosum,
     xlab = "OOB Predicted", ylab = "Actual",
     main = "OOB Predicted vs Actual")
abline(0, 1)
```

# Out-of-Bag Random Forest using Logit Transformation
```{r}
clean_data_percent<-clean_data%>%
  mutate(across(all_of(percent_cover_cols),~./100)) #converting to a 0 - 1 scale for logit transformation
logit_data<-clean_data_percent%>%
  mutate(across(all_of(percent_cover_cols),~qlogis(pmin(pmax(.,0.0001),1-0.0001)))) 
#have to limit the range from 0.0001 to 0.9999 otherwise it gives me NaNs and -Inf values.

logit_skew_fuc<-skewness(logit_data$rockweed_fucus_spp)
logit_skew_asco<-skewness(logit_data$knotted_wrack_a_nodosum)
skew_fuc<-skewness(clean_data$rockweed_fucus_spp)
skew_asco<-skewness(clean_data$knotted_wrack_a_nodosum)


logit_data_lag <- logit_data %>%
  arrange(plot_id, start_date) %>%
  group_by(plot_id) %>%
  mutate(across(all_of(percent_cover_cols), 
                ~ dplyr::lag(., n = 1), 
                .names = "lag1_{col}")) %>%
  ungroup()

# Keep only rows where lag exists; drop first year per site
logit_data_lag <- logit_data_lag %>%
  filter(!is.na(lag1_rockweed_fucus_spp))

# Ascophyllum lagged predictors
asco_predictors <- grep("^lag1_", names(logit_data_lag), value = TRUE)
formula_asco <- as.formula(
  paste("knotted_wrack_a_nodosum ~", paste(asco_predictors, collapse = " + "))
)
# Fucus lagged predictors
fuc_predictors <- grep("^lag1_", names(logit_data_lag), value = TRUE)
formula_fuc <- as.formula(
  paste("rockweed_fucus_spp ~", paste(fuc_predictors, collapse = " + "))
)

oob_asco <- randomForest(formula_asco, data = logit_data_lag, ntree = 500, importance = TRUE)
oob_fuc  <- randomForest(formula_fuc,  data = logit_data_lag, ntree = 500, importance = TRUE)

print(oob_asco)
print(oob_fuc)

# Example OOB plot
plot(oob_asco$predicted, logit_data_lag$knotted_wrack_a_nodosum,
     xlab = "OOB Predicted", ylab = "Actual",
     main = "Logit Transformed OOB Predicted vs Actual")
abline(0, 1)
```

```{r}
# Ascophyllum back-transform
asco_pred_pct <- 100 * plogis(oob_asco$predicted)

# Fucus back-transform
fuc_pred_pct <- 100 * plogis(oob_fuc$predicted)
asco_actual <- clean_data_lag$knotted_wrack_a_nodosum
fuc_actual  <- clean_data_lag$rockweed_fucus_spp

# MSE
mse_asco <- mean((asco_actual - asco_pred_pct)^2)
mse_fuc  <- mean((fuc_actual  - fuc_pred_pct)^2)

sqrt(mse_asco)
sqrt(mse_fuc)
```

# Feature Selection
```{r}
models <- list(
  asco_oob = oob_asco,
  fuc_oob  = oob_fuc
)

importance_vals <- lapply(models, as.data.frame(importance))

# selecting variables that, when removed, do not increase the mean squared error in either model. Variables with a value above 0 represent variables that are helping the model reduce error by being present. Variables with a value of 0 or below do not contribute to model performance with their presence, or, in the case of negative values, actively detract from it.
unimportant_vars <- union(
  rownames(filter(importance_vals$asco_oob, value..IncMSE <= 0)),
  rownames(filter(importance_vals$fuc_oob,  value..IncMSE <= 0))
)

#logit_data<-logit_data%>%
#  select(-unimportant_vars)
```

# OOB Random Forest w/ Logit Transformation and Feature Selection
```{r}
oob_asco<-randomForest(knotted_wrack_a_nodosum~.,data=logit_data,ntree=500,importance=TRUE)
oob_fuc<-randomForest(rockweed_fucus_spp~.,data=logit_data,ntree=500,importance=TRUE)


print(oob_asco)
print(oob_fuc)

plot(oob_asco$predicted,logit_data$knotted_wrack_a_nodosum,
     xlab = "OOB Predicted", ylab = "Actual",
     main = "OOB Predicted vs Actual")
  abline(0, 1)


# Get predictions from  random forest model
pred_asc<-predict(oob_asco, newdata = logit_data)
pred_fuc<-predict(oob_fuc, newdata = logit_data)

# Actual values on logit scale
actual_asc<-logit_data$knotted_wrack_a_nodosum
actual_fuc<-logit_data$rockweed_fucus_spp

# Back-transform to proportion scale
actual_asc_prop<-plogis(actual_asc)
pred_asc_prop<-plogis(pred_asc)

actual_fuc_prop<-plogis(actual_fuc)
pred_fuc_prop<-plogis(pred_fuc)

# Calculate proportion errors (absolute)
asc_error_prop<-abs(pred_asc_prop - actual_asc_prop)
fuc_error_prop<-abs(pred_fuc_prop - actual_fuc_prop)

# Make a tidy dataframe for plotting
df_plot<-bind_rows(
  data.frame(
    species = "Ascophyllum",
    actual_cover = actual_asc_prop,
    error_cover = asc_error_prop
  ),
  data.frame(
    species = "Fucus",
    actual_cover = actual_fuc_prop,
    error_cover = fuc_error_prop
  )
)

# Plot error vs. actual cover
ggplot(df_plot, aes(x = actual_cover * 100, y = error_cover * 100, color = species)) +
  geom_point(alpha = 0.4) +
  geom_smooth(se = FALSE) +
  labs(
    x = "Actual % Cover",
    y = "Absolute Error (% cover)",
    title = "OOB Random Forest Prediction Error vs. Actual Percent Cover",
    subtitle = "Back-transformed from logit space"
  ) +
  theme_minimal()
```

# Time Lagged Logit Modeling Function
```{r}
run_lagged_rf_logit <- function(df, percent_cover_cols){
  # 1. Convert percent to 0-1 and logit-transform
    df <- df %>%
    mutate(across(all_of(percent_cover_cols), ~ . / 100)) %>%
    mutate(across(all_of(percent_cover_cols), ~ qlogis(pmin(pmax(., 0.0001), 0.9999))))
  # 2. Create 1-year lagged predictors by plot_id
  df_lag <- df %>%
    arrange(plot_id, start_date) %>%
    group_by(plot_id) %>%
    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = "lag1_{col}")) %>%
    ungroup() %>%
    filter(!is.na(lag1_rockweed_fucus_spp))
  
  # 3. Random Forest model formulas
  predictors <- grep("^lag1_", names(df_lag), value = TRUE)
  formula_asco <- as.formula(paste("knotted_wrack_a_nodosum ~", paste(predictors, collapse = " + ")))
  formula_fuc <- as.formula(paste("rockweed_fucus_spp ~", paste(predictors, collapse = " + ")))
  
  # 4. Cross-validation setup
  train_control <- trainControl(method = "cv", number = 10)
  
  # 5. Tune grid for mtry and ntree together
  mtry_values <- seq(2, length(predictors), by = 2)
  ntree_values <- seq(100, 1000, by=50)
  tune_grid <- expand.grid(mtry = mtry_values, .ntree = ntree_values) # placeholder for caret; will handle ntree in loop
  
  # 6. Tune Ascophyllum RF
  best_rmse_asco <- Inf
  for (m in mtry_values) {
    for (n in ntree_values) {
      model <- randomForest(formula_asco, df_lag, mtry = m, ntree = n)
      preds <- predict(model, df_lag)
      rmse_val <- sqrt(mean((100*plogis(preds) - 100*plogis(df_lag$knotted_wrack_a_nodosum))^2))
      if (rmse_val < best_rmse_asco) {
        best_rmse_asco <- rmse_val
        rf_asco <- model
      }
    }
  }
  
  # 7. Tune Fucus RF
  best_rmse_fuc <- Inf
  for (m in mtry_values) {
    for (n in ntree_values) {
      model <- randomForest(formula_fuc, df_lag, mtry = m, ntree = n)
      preds <- predict(model, df_lag)
      rmse_val <- sqrt(mean((100*plogis(preds) - 100*plogis(df_lag$rockweed_fucus_spp))^2))
      if (rmse_val < best_rmse_fuc) {
        best_rmse_fuc <- rmse_val
        rf_fuc <- model
      }
    }
  }
  
  # 8. Predict on training data
  pred_asco <- 100 * plogis(predict(rf_asco, df_lag))
  pred_fuc  <- 100 * plogis(predict(rf_fuc, df_lag))
  actual_asco <- 100 * plogis(df_lag$knotted_wrack_a_nodosum)
  actual_fuc  <- 100 * plogis(df_lag$rockweed_fucus_spp)
  
  # 9. Compute metrics
  metrics <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    R2 = c(cor(actual_asco, pred_asco)^2, cor(actual_fuc, pred_fuc)^2),
    MSE = c(mean((actual_asco - pred_asco)^2), mean((actual_fuc - pred_fuc)^2)),
    RMSE = c(sqrt(mean((actual_asco - pred_asco)^2)), sqrt(mean((actual_fuc - pred_fuc)^2)))
  )
  
  # 10. Collect best hyperparameters
  best_params <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    mtry = c(rf_asco$mtry, rf_fuc$mtry),
    ntree = c(rf_asco$ntree, rf_fuc$ntree)
  )
  
  return(list(Metrics = metrics, Best_Hyperparameters = best_params))
}

#run_lagged_rf(logit_data,percent_cover_cols = percent_cover_cols)
```

# Flexible Modeling Function

```{r}
flexible_lagged_oob_model <- function(df, percent_cover_cols, logit_transform = FALSE, unimportant_vars) {
  
  # 1. Optional logit transform
  if(logit_transform) {
    df <- df %>%
      mutate(across(all_of(percent_cover_cols), ~ . / 100)) %>%
      mutate(across(all_of(percent_cover_cols), ~ qlogis(pmin(pmax(., 0.0001), 0.9999))))
  }
  
  # 2. Create 1-year lagged predictors
  df_lag <- df %>%
    arrange(plot_id, start_date) %>%
    group_by(plot_id) %>%
    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = "lag1_{col}")) %>%
    ungroup() %>%
    filter(!is.na(lag1_rockweed_fucus_spp))%>%
    select(-unimportant_vars)
  
  # 3. Formulas
  predictors <- grep("^lag1_", names(df_lag), value = TRUE)
  formula_asco <- as.formula(paste("knotted_wrack_a_nodosum ~", paste(predictors, collapse = " + ")))
  formula_fuc <- as.formula(paste("rockweed_fucus_spp ~", paste(predictors, collapse = " + ")))
  
  # 4. Default tuning ranges
  mtry_values <- seq(2, floor(length(predictors)/2), by = 2)
  ntree_values <- seq(200, 1000, by = 100)
  
  # 5. Tune Ascophyllum RF
  best_rmse_asco <- Inf
  for(m in mtry_values){
    for(n in ntree_values){
      model <- randomForest(formula_asco, df_lag, mtry = m, ntree = n)
      preds <- predict(model, df_lag)
      if(logit_transform) preds <- 100 * plogis(preds)
      rmse_val <- sqrt(mean((preds - df_lag$knotted_wrack_a_nodosum)^2))
      if(rmse_val < best_rmse_asco){
        best_rmse_asco <- rmse_val
        rf_asco <- model
      }
    }
  }
  
  # 6. Tune Fucus RF
  best_rmse_fuc <- Inf
  for(m in mtry_values){
    for(n in ntree_values){
      model <- randomForest(formula_fuc, df_lag, mtry = m, ntree = n)
      preds <- predict(model, df_lag)
      if(logit_transform) preds <- 100 * plogis(preds)
      rmse_val <- sqrt(mean((preds - df_lag$rockweed_fucus_spp)^2))
      if(rmse_val < best_rmse_fuc){
        best_rmse_fuc <- rmse_val
        rf_fuc <- model
      }
    }
  }
  
  # 7. Predictions
  pred_asco <- predict(rf_asco, df_lag)
  pred_fuc <- predict(rf_fuc, df_lag)
  if(logit_transform){
    pred_asco <- 100 * plogis(pred_asco)
    pred_fuc <- 100 * plogis(pred_fuc)
  }
  
  # 8. Metrics
  metrics <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    R2 = c(cor(df_lag$knotted_wrack_a_nodosum, pred_asco)^2,
           cor(df_lag$rockweed_fucus_spp, pred_fuc)^2),
    MSE = c(mean((df_lag$knotted_wrack_a_nodosum - pred_asco)^2),
            mean((df_lag$rockweed_fucus_spp - pred_fuc)^2)),
    RMSE = c(sqrt(mean((df_lag$knotted_wrack_a_nodosum - pred_asco)^2)),
             sqrt(mean((df_lag$rockweed_fucus_spp - pred_fuc)^2)))
  )
  
  # 9. Best hyperparameters
  best_params <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    mtry = c(rf_asco$mtry, rf_fuc$mtry),
    ntree = c(rf_asco$ntree, rf_fuc$ntree)
  )
  
  return(list(Metrics = metrics, Best_Hyperparameters = best_params))
}
```

# Flexible Random Forest using training/test split data
```{r}
flexible_lagged_rf_model <- function(df, percent_cover_cols, logit_transform = FALSE, unimportant_vars) {
  
  # 1. Optional logit transform
  if(logit_transform) {
    df <- df %>%
      mutate(across(all_of(percent_cover_cols), ~ . / 100)) %>%
      mutate(across(all_of(percent_cover_cols), ~ qlogis(pmin(pmax(., 0.0001), 0.9999))))
  }

  # 2. Create 1-year lagged predictors
  df_lag <- df %>%
    arrange(plot_id, start_date) %>%
    group_by(plot_id) %>%
    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = "lag1_{col}")) %>%
    ungroup() %>%
    filter(!is.na(lag1_rockweed_fucus_spp)) %>%
    select(-unimportant_vars)
  
  train_data <- df_lag %>% filter(start_date != 2018)
  test_data  <- df_lag %>% filter(start_date == 2018)

  # 4. Formulas
  predictors <- grep("^lag1_", names(df_lag), value = TRUE)
  formula_asco <- as.formula(paste("knotted_wrack_a_nodosum ~", 
                                   paste(predictors, collapse = " + ")))
  formula_fuc <- as.formula(paste("rockweed_fucus_spp ~", 
                                  paste(predictors, collapse = " + ")))
  
  # 5. Tuning ranges
  mtry_values <- seq(2, floor(length(predictors)/2), by = 2)
  ntree_values <- seq(1, 1000, by = 50)
  
  # 6. Tune Ascophyllum RF
  best_rmse_asco <- Inf
  for(m in mtry_values){
    for(n in ntree_values){
      model <- randomForest(formula_asco, train_data, mtry = m, ntree = n)
      preds <- predict(model, test_data)
      if(logit_transform) preds <- 100 * plogis(preds)
      rmse_val <- sqrt(mean((preds - test_data$knotted_wrack_a_nodosum)^2))
      if(rmse_val < best_rmse_asco){
        best_rmse_asco <- rmse_val
        rf_asco <- model
      }
    }
  }
  
  # 7. Tune Fucus RF
  best_rmse_fuc <- Inf
  for(m in mtry_values){
    for(n in ntree_values){
      model <- randomForest(formula_fuc, train_data, mtry = m, ntree = n)
      preds <- predict(model, test_data)
      if(logit_transform) preds <- 100 * plogis(preds)
      rmse_val <- sqrt(mean((preds - test_data$rockweed_fucus_spp)^2))
      if(rmse_val < best_rmse_fuc){
        best_rmse_fuc <- rmse_val
        rf_fuc <- model
      }
    }
  }
  
  # 8. Predictions
  pred_asco <- predict(rf_asco, test_data)
  pred_fuc <- predict(rf_fuc, test_data)
  if(logit_transform){
    pred_asco <- 100 * plogis(pred_asco)
    pred_fuc <- 100 * plogis(pred_fuc)
  }
  
  # 9. Metrics
  metrics <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    R2 = c(cor(test_data$knotted_wrack_a_nodosum, pred_asco)^2,
           cor(test_data$rockweed_fucus_spp, pred_fuc)^2),
    MSE = c(mean((test_data$knotted_wrack_a_nodosum - pred_asco)^2),
            mean((test_data$rockweed_fucus_spp - pred_fuc)^2)),
    RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - pred_asco)^2)),
             sqrt(mean((test_data$rockweed_fucus_spp - pred_fuc)^2)))
  )
  
  # 10. Best hyperparameters
  best_params <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    mtry = c(rf_asco$mtry, rf_fuc$mtry),
    ntree = c(rf_asco$ntree, rf_fuc$ntree)
  )
  # 11. Baseline for model comparison
  baseline_asco <- test_data$lag1_knotted_wrack_a_nodosum
  baseline_fuc  <- test_data$lag1_rockweed_fucus_spp

  baseline_metrics <- data.frame(
  Species = c("Ascophyllum", "Fucus"),
  R2  = c(cor(test_data$knotted_wrack_a_nodosum, baseline_asco)^2,
          cor(test_data$rockweed_fucus_spp, baseline_fuc)^2),
  MSE = c(mean((test_data$knotted_wrack_a_nodosum - baseline_asco)^2),
          mean((test_data$rockweed_fucus_spp - baseline_fuc)^2)),
  RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - baseline_asco)^2)),
           sqrt(mean((test_data$rockweed_fucus_spp - baseline_fuc)^2)))
)
  if(logit_transform){
  baseline_metrics <- data.frame(
  Species = c("Ascophyllum", "Fucus"),
  R2  = c(cor(test_data$knotted_wrack_a_nodosum, baseline_asco)^2,
          cor(test_data$rockweed_fucus_spp, baseline_fuc)^2),
  MSE = c(mean((100*plogis(test_data$knotted_wrack_a_nodosum) - baseline_asco)^2),
          mean((100*plogis(test_data$rockweed_fucus_spp) - baseline_fuc)^2)),
  RMSE = c(sqrt(mean((100*plogis(test_data$knotted_wrack_a_nodosum) - baseline_asco)^2)),
           sqrt(mean((100*plogis(test_data$rockweed_fucus_spp) - baseline_fuc)^2)))
)}
  # 12. Return baseline and modeling metrics
  return(list(
  RF_Metrics = metrics,
  Baseline_Metrics = baseline_metrics,
  Best_Hyperparameters = best_params))
}

```

# Model Evaluations
```{r}
#Model_results
#logit_results_oob<-flexible_lagged_oob_model(df=clean_data,logit_transform = TRUE, percent_cover_cols = percent_cover_cols, unimportant_vars = unimportant_vars)
#raw_results_oob<-flexible_lagged_oob_model(clean_data,logit_transform = FALSE,percent_cover_cols = percent_cover_cols, unimportant_vars = unimportant_vars)
raw_results<-flexible_lagged_rf_model(clean_data,percent_cover_cols = percent_cover_cols,logit_transform = FALSE, unimportant_vars = unimportant_vars)
logit_results<-flexible_lagged_rf_model(clean_data,percent_cover_cols = percent_cover_cols,logit_transform = TRUE, unimportant_vars = unimportant_vars)
```

Comparison Table
```{r}
# Merge by Species
summary_table <- merge(raw_results$RF_Metrics, raw_results$Baseline_Metrics, by = "Species", suffixes = c("_RF", "_Baseline"))

# Compute improvements
summary_table <- summary_table %>%
  mutate(
    R2_Delta       = R2_RF - R2_Baseline,
    RMSE_Reduction = RMSE_Baseline - RMSE_RF
  ) %>%
  select(Species,
         R2_RF, R2_Baseline, R2_Delta,
         RMSE_RF, RMSE_Baseline, RMSE_Reduction)

#Logit results summary table
summary_table_logit <- merge(logit_results$RF_Metrics, logit_results$Baseline_Metrics, by = "Species", suffixes = c("_RF", "_Baseline")) %>%
  mutate(
    R2_Delta       = R2_RF - R2_Baseline,
    RMSE_Reduction = RMSE_Baseline - RMSE_RF,
    Type = "Logit Random Forest"
  ) %>%
  select(Type, Species, R2_RF, R2_Baseline, R2_Delta, RMSE_RF, RMSE_Baseline, RMSE_Reduction)

# Table for raw_results only
summary_table_raw <- summary_table %>%
  mutate(Type = "Random Forest") %>%
  select(Type, Species, R2_RF, R2_Baseline, R2_Delta, RMSE_RF, RMSE_Baseline, RMSE_Reduction)

# Combine both
final_summary <- rbind(summary_table_raw, summary_table_logit)
final_summary
```

# gt Table for Summary Statistics
```{r}
final_summary_gt <- final_summary %>%
  gt(rowname_col = "Species") %>%
  tab_header(
    title = "Random Forest vs Baseline Performance"
  ) %>%
  fmt_number(
    columns = c(R2_RF, R2_Baseline, R2_Delta, RMSE_RF, RMSE_Baseline, RMSE_Reduction),
    decimals = 3
  ) %>%
  tab_spanner(
    label = "R²",
    columns = c(R2_RF, R2_Baseline, R2_Delta)
  ) %>%
  tab_spanner(
    label = "RMSE",
    columns = c(RMSE_RF, RMSE_Baseline, RMSE_Reduction)
  ) %>%
  cols_label(
    Type = "Model Type",
    R2_RF = "RF",
    R2_Baseline = "Baseline",
    R2_Delta = "Difference",
    RMSE_RF = "RF",
    RMSE_Baseline = "Baseline",
    RMSE_Reduction = "Difference"
  )

final_summary_gt
```

# xgBoost
```{r}
xgb_model <- function(df, percent_cover_cols, unimportant_vars) {
  
  #Create 1-year lagged predictor vars
  df_lag <- df %>%
    arrange(plot_id, start_date) %>%
    group_by(plot_id) %>%
    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = "lag1_{col}")) %>%
    ungroup() %>%
    filter(!is.na(lag1_rockweed_fucus_spp)) %>%
    select(-unimportant_vars)
  
  #Train-test split
  train_data <- df_lag %>% filter(start_date != 2018)
  test_data  <- df_lag %>% filter(start_date == 2018)
  
  predictors <- grep("^lag1_", names(df_lag), value = TRUE)
  
  #Set up hyperparameter grid
  eta_values <- c(0.05, 0.1, 0.2)
  max_depth_values <- c(3, 5, 7)
  subsample_values <- c(0.7, 0.8, 1)
  colsample_values <- c(0.7, 0.8, 1)
  
  #Optimize Ascophyllum XGBoost
  best_rmse_asco <- Inf
  for(eta in eta_values){
    for(md in max_depth_values){
      for(ss in subsample_values){
        for(cs in colsample_values){
          
          dtrain <- xgb.DMatrix(as.matrix(train_data[, predictors]), label = train_data$knotted_wrack_a_nodosum)
          dtest  <- xgb.DMatrix(as.matrix(test_data[, predictors]), label = test_data$knotted_wrack_a_nodosum)
          
          model <- xgb.train(
            params = list(objective = "reg:squarederror",
                          eta = eta,
                          max_depth = md,
                          subsample = ss,
                          colsample_bytree = cs),
            data = dtrain,
            nrounds = 1000,
            watchlist = list(val = dtest),
            early_stopping_rounds = 20,
            verbose = 0
          )
          
          preds <- predict(model, dtest)
          rmse_val <- sqrt(mean((preds - test_data$knotted_wrack_a_nodosum)^2))
          
          if(rmse_val < best_rmse_asco){
            best_rmse_asco <- rmse_val
            xgb_asco <- model
            best_params_asco <- list(eta = eta, max_depth = md, subsample = ss,
                                     colsample_bytree = cs, nrounds = model$best_iteration)
          }
        }
      }
    }
  }
  
  #Tune Fucus XGBoost model
  best_rmse_fuc <- Inf
  for(eta in eta_values){
    for(md in max_depth_values){
      for(ss in subsample_values){
        for(cs in colsample_values){
          
          dtrain <- xgb.DMatrix(as.matrix(train_data[, predictors]), label = train_data$rockweed_fucus_spp)
          dtest  <- xgb.DMatrix(as.matrix(test_data[, predictors]), label = test_data$rockweed_fucus_spp)
          
          model <- xgb.train(
            params = list(objective = "reg:squarederror",
                          eta = eta,
                          max_depth = md,
                          subsample = ss,
                          colsample_bytree = cs),
            data = dtrain,
            nrounds = 1000,
            watchlist = list(val = dtest),
            early_stopping_rounds = 20,
            verbose = 0
          )
          
          preds <- predict(model, dtest)
          rmse_val <- sqrt(mean((preds - test_data$rockweed_fucus_spp)^2))
          
          if(rmse_val < best_rmse_fuc){
            best_rmse_fuc <- rmse_val
            xgb_fuc <- model
            best_params_fuc <- list(eta = eta, max_depth = md, subsample = ss,
                                    colsample_bytree = cs, nrounds = model$best_iteration)
          }
        }
      }
    }
  }
  
  #Pulling Predictions
  pred_asco <- predict(xgb_asco, as.matrix(test_data[, predictors]))
  pred_fuc <- predict(xgb_fuc, as.matrix(test_data[, predictors]))
  
  #Pulling Metrics
  metrics <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    R2 = c(cor(test_data$knotted_wrack_a_nodosum, pred_asco)^2,
           cor(test_data$rockweed_fucus_spp, pred_fuc)^2),
    RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - pred_asco)^2)),
             sqrt(mean((test_data$rockweed_fucus_spp - pred_fuc)^2)))
  )
  
  #Baseline metrics
  baseline_asco <- test_data$lag1_knotted_wrack_a_nodosum
  baseline_fuc  <- test_data$lag1_rockweed_fucus_spp
  baseline_metrics <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    R2  = c(cor(test_data$knotted_wrack_a_nodosum, baseline_asco)^2,
            cor(test_data$rockweed_fucus_spp, baseline_fuc)^2),
    RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - baseline_asco)^2)),
             sqrt(mean((test_data$rockweed_fucus_spp - baseline_fuc)^2)))
  )
  
  #Pulling hyperparameters
  best_params <- data.frame(
    Species = c("Ascophyllum", "Fucus"),
    eta = c(best_params_asco$eta, best_params_fuc$eta),
    max_depth = c(best_params_asco$max_depth, best_params_fuc$max_depth),
    subsample = c(best_params_asco$subsample, best_params_fuc$subsample),
    colsample_bytree = c(best_params_asco$colsample_bytree, best_params_fuc$colsample_bytree),
    nrounds = c(best_params_asco$nrounds, best_params_fuc$nrounds),
    best_rmse = c(best_rmse_asco, best_rmse_fuc)
  )
  
  #output results
  return(list(
    XGB_Metrics = metrics,
    Baseline_Metrics = baseline_metrics,
    Best_Hyperparameters = best_params
  ))
}
```

xgBoost evaluation
```{r}
xgb_results<-xgb_model(clean_data,percent_cover_cols = percent_cover_cols,unimportant_vars = unimportant_vars)
# Merge by Species
summary_table_xgb <- merge(xgb_results$XGB_Metrics, xgb_results$Baseline_Metrics, by = "Species", suffixes = c("_XGB", "_Baseline"))

# Compute improvements
summary_table_xgb <- summary_table_xgb %>%
  mutate(
    R2_Delta       = R2_XGB - R2_Baseline,
    RMSE_Reduction = RMSE_Baseline - RMSE_XGB,
    Type = "xgBoost"
  ) %>%
  select(Type, Species,
         R2_XGB, R2_Baseline, R2_Delta,
         RMSE_XGB, RMSE_Baseline, RMSE_Reduction)
summary_table_xgb

names(summary_table_raw)<-c("Type","Species","R2","R2_Baseline","R2_Delta","RMSE","RMSE_Baseline","RMSE_Reduction")
names(summary_table_logit)<-c("Type","Species","R2","R2_Baseline","R2_Delta","RMSE","RMSE_Baseline","RMSE_Reduction")
names(summary_table_xgb)<-c("Type","Species","R2","R2_Baseline","R2_Delta","RMSE","RMSE_Baseline","RMSE_Reduction")

final_summary<-rbind(summary_table_raw,summary_table_logit,summary_table_xgb)
final_summary
```
# Final Summary gt Table
```{r}
final_summary_gt <- final_summary %>%
  gt(rowname_col = "Species") %>%
  tab_header(
    title = "Random Forest and xgBoost vs Baseline Performance"
  ) %>%
  fmt_number(
    columns = c(R2, R2_Baseline, R2_Delta, RMSE, RMSE_Baseline, RMSE_Reduction),
    decimals = 3
  ) %>%
  tab_spanner(
    label = "R²",
    columns = c(R2, R2_Baseline, R2_Delta),
    id = "R2_spanner"
  ) %>%
  tab_spanner(
    label = "RMSE",
    columns = c(RMSE, RMSE_Baseline, RMSE_Reduction),
    id = "RMSE_spanner"
  ) %>%
  cols_label(
    Type = "Model Type",
    R2 = "Model",
    R2_Baseline = "Baseline",
    R2_Delta = "Difference",
    RMSE = "Model",
    RMSE_Baseline = "Baseline",
    RMSE_Reduction = "Difference"
  ) %>%
  tab_row_group(
    label = "xgBoost",
    rows = Type == "xgBoost"
  ) %>%
  tab_row_group(
    label = "Logit Transformed Random Forest",
    rows = Type == "Logit Random Forest"
  ) %>%
  tab_row_group(
    label = "Untransformed Random Forest",
    rows = Type == "Random Forest"
  ) %>%
  tab_style(
    style=cell_text(style="italic"),
    locations = cells_row_groups()
  ) %>%
  cols_hide(columns = "Type")

final_summary_gt%>%
  gtsave("rf_xgboost_comparison_table.png")
```


