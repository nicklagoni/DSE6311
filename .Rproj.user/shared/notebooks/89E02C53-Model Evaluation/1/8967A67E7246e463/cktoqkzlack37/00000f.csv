"0","flexible_lagged_oob_model <- function(df, percent_cover_cols, logit_transform = FALSE, unimportant_vars) {"
"0","  "
"0","  # 1. Optional logit transform"
"0","  if(logit_transform) {"
"0","    df <- df %>%"
"0","      mutate(across(all_of(percent_cover_cols), ~ . / 100)) %>%"
"0","      mutate(across(all_of(percent_cover_cols), ~ qlogis(pmin(pmax(., 0.0001), 0.9999))))"
"0","  }"
"0","  "
"0","  # 2. Create 1-year lagged predictors"
"0","  df_lag <- df %>%"
"0","    arrange(plot_id, start_date) %>%"
"0","    group_by(plot_id) %>%"
"0","    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = ""lag1_{col}"")) %>%"
"0","    ungroup() %>%"
"0","    filter(!is.na(lag1_rockweed_fucus_spp))%>%"
"0","    select(-unimportant_vars)"
"0","  "
"0","  # 3. Formulas"
"0","  predictors <- grep(""^lag1_"", names(df_lag), value = TRUE)"
"0","  formula_asco <- as.formula(paste(""knotted_wrack_a_nodosum ~"", paste(predictors, collapse = "" + "")))"
"0","  formula_fuc <- as.formula(paste(""rockweed_fucus_spp ~"", paste(predictors, collapse = "" + "")))"
"0","  "
"0","  # 4. Default tuning ranges"
"0","  mtry_values <- seq(2, length(predictors), by = 1)"
"0","  ntree_values <- seq(1, 1000, by = 50)"
"0","  "
"0","  # 5. Tune Ascophyllum RF"
"0","  best_rmse_asco <- Inf"
"0","  for(m in mtry_values){"
"0","    for(n in ntree_values){"
"0","      model <- randomForest(formula_asco, df_lag, mtry = m, ntree = n)"
"0","      preds <- predict(model, df_lag)"
"0","      if(logit_transform) preds <- 100 * plogis(preds)"
"0","      rmse_val <- sqrt(mean((preds - df_lag$knotted_wrack_a_nodosum)^2))"
"0","      if(rmse_val < best_rmse_asco){"
"0","        best_rmse_asco <- rmse_val"
"0","        rf_asco <- model"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 6. Tune Fucus RF"
"0","  best_rmse_fuc <- Inf"
"0","  for(m in mtry_values){"
"0","    for(n in ntree_values){"
"0","      model <- randomForest(formula_fuc, df_lag, mtry = m, ntree = n)"
"0","      preds <- predict(model, df_lag)"
"0","      if(logit_transform) preds <- 100 * plogis(preds)"
"0","      rmse_val <- sqrt(mean((preds - df_lag$rockweed_fucus_spp)^2))"
"0","      if(rmse_val < best_rmse_fuc){"
"0","        best_rmse_fuc <- rmse_val"
"0","        rf_fuc <- model"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 7. Predictions"
"0","  pred_asco <- predict(rf_asco, df_lag)"
"0","  pred_fuc <- predict(rf_fuc, df_lag)"
"0","  if(logit_transform){"
"0","    pred_asco <- 100 * plogis(pred_asco)"
"0","    pred_fuc <- 100 * plogis(pred_fuc)"
"0","  }"
"0","  "
"0","  # 8. Metrics"
"0","  metrics <- data.frame("
"0","    Species = c(""Ascophyllum"", ""Fucus""),"
"0","    R2 = c(cor(df_lag$knotted_wrack_a_nodosum, pred_asco)^2,"
"0","           cor(df_lag$rockweed_fucus_spp, pred_fuc)^2),"
"0","    MSE = c(mean((df_lag$knotted_wrack_a_nodosum - pred_asco)^2),"
"0","            mean((df_lag$rockweed_fucus_spp - pred_fuc)^2)),"
"0","    RMSE = c(sqrt(mean((df_lag$knotted_wrack_a_nodosum - pred_asco)^2)),"
"0","             sqrt(mean((df_lag$rockweed_fucus_spp - pred_fuc)^2)))"
"0","  )"
"0","  "
"0","  # 9. Best hyperparameters"
"0","  best_params <- data.frame("
"0","    Species = c(""Ascophyllum"", ""Fucus""),"
"0","    mtry = c(rf_asco$mtry, rf_fuc$mtry),"
"0","    ntree = c(rf_asco$ntree, rf_fuc$ntree)"
"0","  )"
"0","  "
"0","  return(list(Metrics = metrics, Best_Hyperparameters = best_params))"
"0","}"
