"0","flexible_lagged_rf_model <- function(df, percent_cover_cols, logit_transform = FALSE, unimportant_vars) {"
"0","  "
"0","  # 1. Optional logit transform"
"0","  if(logit_transform) {"
"0","    df <- df %>%"
"0","      mutate(across(all_of(percent_cover_cols), ~ . / 100)) %>%"
"0","      mutate(across(all_of(percent_cover_cols), ~ qlogis(pmin(pmax(., 0.0001), 0.9999))))"
"0","  }"
"0",""
"0","  # 2. Create 1-year lagged predictors"
"0","  df_lag <- df %>%"
"0","    arrange(plot_id, start_date) %>%"
"0","    group_by(plot_id) %>%"
"0","    mutate(across(all_of(percent_cover_cols), ~ dplyr::lag(., n = 1), .names = ""lag1_{col}"")) %>%"
"0","    ungroup() %>%"
"0","    filter(!is.na(lag1_rockweed_fucus_spp)) %>%"
"0","    select(-unimportant_vars)"
"0","  "
"0","  # 3. Train-Test Split"
"0","    calcSplitRatio <- function(df) {"
"0","  p <- ncol(df) -1 "
"0","  test_N <- (1/sqrt(p))*nrow(df)"
"0","  test_prop <- round((1/sqrt(p))*nrow(df)/nrow(df), 2)"
"0","  train_prop <- 1-test_prop"
"0","  print(paste0(""The ideal split ratio is "", train_prop, "":"", test_prop, "" training:testing""))"
"0","  return(train_prop)"
"0","}"
"0",""
"0","train_data <- df_lag %>% filter(start_date != 2018)"
"0","test_data  <- df_lag %>% filter(start_date == 2018)"
"0",""
"0","  # 4. Formulas"
"0","  predictors <- grep(""^lag1_"", names(df_lag), value = TRUE)"
"0","  formula_asco <- as.formula(paste(""knotted_wrack_a_nodosum ~"", "
"0","                                   paste(predictors, collapse = "" + "")))"
"0","  formula_fuc <- as.formula(paste(""rockweed_fucus_spp ~"", "
"0","                                  paste(predictors, collapse = "" + "")))"
"0","  "
"0","  # 5. Tuning ranges"
"0","  mtry_values <- seq(2, floor(length(predictors)/2), by = 2)"
"0","  ntree_values <- seq(1, 1000, by = 50)"
"0","  "
"0","  # 6. Tune Ascophyllum RF"
"0","  best_rmse_asco <- Inf"
"0","  for(m in mtry_values){"
"0","    for(n in ntree_values){"
"0","      model <- randomForest(formula_asco, train_data, mtry = m, ntree = n)"
"0","      preds <- predict(model, test_data)"
"0","      if(logit_transform) preds <- 100 * plogis(preds)"
"0","      rmse_val <- sqrt(mean((preds - test_data$knotted_wrack_a_nodosum)^2))"
"0","      if(rmse_val < best_rmse_asco){"
"0","        best_rmse_asco <- rmse_val"
"0","        rf_asco <- model"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 7. Tune Fucus RF"
"0","  best_rmse_fuc <- Inf"
"0","  for(m in mtry_values){"
"0","    for(n in ntree_values){"
"0","      model <- randomForest(formula_fuc, train_data, mtry = m, ntree = n)"
"0","      preds <- predict(model, test_data)"
"0","      if(logit_transform) preds <- 100 * plogis(preds)"
"0","      rmse_val <- sqrt(mean((preds - test_data$rockweed_fucus_spp)^2))"
"0","      if(rmse_val < best_rmse_fuc){"
"0","        best_rmse_fuc <- rmse_val"
"0","        rf_fuc <- model"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 8. Predictions"
"0","  pred_asco <- predict(rf_asco, test_data)"
"0","  pred_fuc <- predict(rf_fuc, test_data)"
"0","  if(logit_transform){"
"0","    pred_asco <- 100 * plogis(pred_asco)"
"0","    pred_fuc <- 100 * plogis(pred_fuc)"
"0","  }"
"0","  "
"0","  # 9. Metrics"
"0","  metrics <- data.frame("
"0","    Species = c(""Ascophyllum"", ""Fucus""),"
"0","    R2 = c(cor(test_data$knotted_wrack_a_nodosum, pred_asco)^2,"
"0","           cor(test_data$rockweed_fucus_spp, pred_fuc)^2),"
"0","    MSE = c(mean((test_data$knotted_wrack_a_nodosum - pred_asco)^2),"
"0","            mean((test_data$rockweed_fucus_spp - pred_fuc)^2)),"
"0","    RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - pred_asco)^2)),"
"0","             sqrt(mean((test_data$rockweed_fucus_spp - pred_fuc)^2)))"
"0","  )"
"0","  "
"0","  # 10. Best hyperparameters"
"0","  best_params <- data.frame("
"0","    Species = c(""Ascophyllum"", ""Fucus""),"
"0","    mtry = c(rf_asco$mtry, rf_fuc$mtry),"
"0","    ntree = c(rf_asco$ntree, rf_fuc$ntree)"
"0","  )"
"0","  # 11. Baseline for model comparison"
"0","  baseline_asco <- test_data$lag1_knotted_wrack_a_nodosum"
"0","  baseline_fuc  <- test_data$lag1_rockweed_fucus_spp"
"0",""
"0","  baseline_metrics <- data.frame("
"0","  Species = c(""Ascophyllum"", ""Fucus""),"
"0","  R2  = c(cor(test_data$knotted_wrack_a_nodosum, baseline_asco)^2,"
"0","          cor(test_data$rockweed_fucus_spp, baseline_fuc)^2),"
"0","  MSE = c(mean((test_data$knotted_wrack_a_nodosum - baseline_asco)^2),"
"0","          mean((test_data$rockweed_fucus_spp - baseline_fuc)^2)),"
"0","  RMSE = c(sqrt(mean((test_data$knotted_wrack_a_nodosum - baseline_asco)^2)),"
"0","           sqrt(mean((test_data$rockweed_fucus_spp - baseline_fuc)^2)))"
"0",")"
"0","  # 12. Return baseline and modeling metrics"
"0","  return(list("
"0","  RF_Metrics = metrics,"
"0","  Baseline_Metrics = baseline_metrics,"
"0","  Best_Hyperparameters = best_params))"
"0","}"
"0",""
