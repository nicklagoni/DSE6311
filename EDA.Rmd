---
title: "DSE6311 - Exploratory Data Analysis"
author: "Nick Lagoni"
date: "`r Sys.Date()`"
output: html_document
---

#Setup
```{r}
Sys.setenv(lang='en')
library(readr)
library(tidyverse)
library(dplyr)
library(purrr)
library(GGally)
library(corrplot)
library(reshape2)
library(patchwork)
library(e1071)
library(gt)
library(magick)
```


# Data Input
```{r}
transects<-read.csv("transects.csv")
echinoderm_counts<-read.csv("echinoderm_counts.csv")
echinoderm_measurements<-read.csv("echinoderm_measurements.csv")
motileInvert_counts<-read.csv("motileInvert_counts.csv")
motileInvert_measurements<-read.csv("motileInvert_measurements.csv")
photoquadrats<-read.csv("photoquadrats.csv")

```

# Data Preprocessing

### Tidying the Data
```{r}
#Photoplots Pivot
photoquadrats_pivot<-photoquadrats%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Perc_Cover)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Perc_Cover,
    values_fn = mean
  )
#Motile Invert Counts Pivot
motileInvert_counts$Count<-motileInvert_counts$Damage+motileInvert_counts$No.Damage
motileInvert_counts_pivot<-motileInvert_counts%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Count)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Count,
    values_fill = 0
  )
motileInvert_counts_pivot<-motileInvert_counts_pivot%>%
  mutate(across(where(is.numeric), ~ ifelse(. < 0, 0, .)))

#Motile Invert Measurements Pivot

motileInvert_measurements_pivot<-motileInvert_measurements%>%
  select(Site_Name,Loc_Name,Target_Species,Plot_Name,Start_Date,Spp_Name,Measurement)%>%
  pivot_wider(
    names_from = Spp_Name,
    values_from = Measurement,
    values_fn = mean,
    values_fill = 0
  )
names(motileInvert_measurements_pivot)[(ncol(motileInvert_measurements_pivot)-5):ncol(motileInvert_measurements_pivot)] <- paste0(names(motileInvert_measurements_pivot)[(ncol(motileInvert_measurements_pivot)-5):ncol(motileInvert_measurements_pivot)], " Mean Measure")
```

### Joining the Data
```{r}
join_cols<-c("Site_Name","Loc_Name","Target_Species","Plot_Name","Start_Date")
final_data<-photoquadrats_pivot%>%
  left_join(motileInvert_counts_pivot,by=join_cols)%>%
  left_join(motileInvert_measurements_pivot,by=join_cols)%>%
  mutate(across(everything(), ~replace_na(., 0)))
```


#Exploratory Data Analysis

### Collinearity
```{r}
corr_matrix <- cor(final_data[sapply(final_data, is.numeric)], use = "complete.obs")
melted_corr <- melt(corr_matrix)

filtered_corr <- melted_corr %>%
  filter(Var1 != Var2, abs(value) > 0.5)

ggplot(filtered_corr, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(limit = c(-1, 1), midpoint = 0) +
  theme_minimal(base_size = 10) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Correlation Heatmap within NETN Rocky Intertidal Photoplots",
    x = "Variable 1",
    y = "Variable 2",
    fill = "Correlation Strength"
  )
```

### Target Variable Distribution
```{r}
par(mfrow=c(1,2))
hist(final_data$`Rockweed (Fucus) spp.`, main = "Fucus spp. Cover", xlab = "Percent Cover")
hist(final_data$`Knotted Wrack (A. nodosum)`, main = "Ascophyllum nodosum Cover", xlab = "Percent Cover")
```

### Relationship Between Motile Invert Abundances and Fucus Percent Cover

```{r}
species_list <- c(
  "`Common periwinkle (Littorina littorea)`" = "Littorina littorea",
  "`Smooth periwinkle (Littorina obtusata)`" = "Littorina obtusata",
  "`Rough periwinkle (Littorina saxatilis)`" = "Littorina saxatilis",
  "`Green crab (Carcinus maenas)`" = "Carcinus maenas",
  "`Limpet (Tectura testudinalis)`" = "Tectura testudinalis"
)
plots <- lapply(names(species_list), function(sp) {
  ggplot(final_data, aes_string(x = sp, y = "`Rockweed (Fucus) spp.`")) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(
      title = paste(species_list[sp], "vs Fucus spp.")
    ) +
    theme_minimal(base_size = 9) +
    theme(
      plot.title = element_text(size = 9),
      axis.title = element_text(size = 8),
      axis.text = element_text(size = 7)
    )
})
wrap_plots(plots, ncol = 3) +
  plot_annotation(
    title = "Relationship between Motile Invertebrate Counts and Fucus Percent Cover",
    theme = theme(
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
    )
  )
```

### Relationship Between Motile Invert Abundances and Ascophyllum Percent Cover
```{r}
species_list <- c(
  "`Common periwinkle (Littorina littorea)`" = "Littorina littorea",
  "`Smooth periwinkle (Littorina obtusata)`" = "Littorina obtusata",
  "`Rough periwinkle (Littorina saxatilis)`" = "Littorina saxatilis",
  "`Green crab (Carcinus maenas)`" = "Carcinus maenas",
  "`Limpet (Tectura testudinalis)`" = "Tectura testudinalis"
)
plots <- lapply(names(species_list), function(sp) {
  ggplot(final_data, aes_string(x = sp, y = "`Knotted Wrack (A. nodosum)`")) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(
      title = paste(species_list[sp], "vs A. nodosum")
    ) +
    theme_minimal(base_size = 9) +
    theme(
      plot.title = element_text(size = 9),
      axis.title = element_text(size = 8),
      axis.text = element_text(size = 7)
    )
})
wrap_plots(plots, ncol = 3) +
  plot_annotation(
    title = "Relationship between Motile Invertebrate Counts and Ascophyllum nodosum Percent Cover",
    theme = theme(
      plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
    )
  )
```

### Continuous Variable Summary Table
```{r}

numeric_data <- final_data %>%
  select(where(is.numeric))

cont_summary <- numeric_data %>%
  summarise(across(
    everything(),
    list(
      Mean = ~round(mean(.x, na.rm = TRUE), 2),
      Median = ~round(median(.x, na.rm = TRUE), 2),
      SD = ~round(sd(.x, na.rm = TRUE), 2),
      Min = ~round(min(.x, na.rm = TRUE), 2),
      Max = ~round(max(.x, na.rm = TRUE), 2),
      Skew = ~round(skewness(.x, na.rm = TRUE), 2),
      Kurtosis = ~round(kurtosis(.x, na.rm = TRUE), 2)
    ),
    .names = "{.col}_{.fn}"
  )) %>%
  tidyr::pivot_longer(everything(), names_to = c("Variable", ".value"), names_sep = "_")

print(cont_summary)


cont_summary %>%
  gt() %>%
  gtsave("table_gt.png")
img <- image_read("table_gt.png")
img_rotated <- image_rotate(img, 90)
image_write(img_rotated, "rotated_table_gt.png")
```
### Principal Component Analysis
```{r}
pca_data <- final_data %>% select(where(is.numeric))
pca_data <- pca_data[, apply(pca_data, 2, var) != 0]
pca_data <- na.omit(pca_data)
pca_result <- prcomp(pca_data, scale. = TRUE, center = TRUE)
explained_var <- summary(pca_result)$importance[2, ]
plot(explained_var,type="b",main="PCA Results Scree Plot",ylab="Proportion of Variance Explained",xlab="Principal Component")
#as.data.frame(explained_var)
```

